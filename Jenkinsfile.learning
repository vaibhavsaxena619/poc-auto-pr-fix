#!/usr/bin/env groovy
/*
  Enhanced Jenkinsfile with Self-Learning Integration
  
  Features:
  1. Records learning outcomes when PRs are merged
  2. Calls webhook handler to update learning database
  3. Displays learning statistics in build output
  4. Monitors pattern promotion progress
*/

pipeline {
    agent any
    
    environment {
        // Learning system settings
        ENABLE_AUTO_FIX = 'true'
        ENABLE_OPENAI_CALLS = 'true'
        ENABLE_LEARNING = 'true'  // NEW: Enable learning feedback
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }
    
    stages {
        stage('Initialize') {
            steps {
                script {
                    echo "üöÄ Starting Build Pipeline"
                    echo "üìö Learning System: ${ENABLE_LEARNING}"
                    
                    // Display current learning stats
                    sh '''
                        echo "=== LEARNING STATUS ==="
                        python3 manage_learning.py stats || echo "Learning DB not yet initialized"
                    '''
                }
            }
        }
        
        stage('Build & Auto-Fix') {
            steps {
                script {
                    echo "üî® Compiling and auto-fixing errors..."
                    
                    sh '''
                        mkdir -p build/classes
                        javac -d build/classes src/App.java || true
                        
                        # Run build_fix_v2.py with learning enabled
                        if [ "${ENABLE_AUTO_FIX}" = "true" ]; then
                            python3 build_fix_v2.py src/App.java
                        fi
                    '''
                }
            }
        }
        
        stage('Process PR Outcomes') {
            when {
                expression {
                    return env.BRANCH_NAME =~ /^fix\// || 
                           env.CHANGE_ID != null ||
                           env.ENABLE_LEARNING == 'true'
                }
            }
            steps {
                script {
                    echo "üìä Processing PR outcomes for learning..."
                    
                    sh '''
                        # This would be triggered by GitHub webhook
                        # For now, we simulate it here
                        
                        if [ -f "error_learning.json" ]; then
                            echo "‚úÖ Learning database exists"
                            echo "üìà Current learning progress:"
                            python3 manage_learning.py promoted || echo "No promoted patterns yet"
                        fi
                    '''
                }
            }
        }
        
        stage('Learning Report') {
            steps {
                script {
                    echo "üìö Learning System Report"
                    
                    sh '''
                        python3 manage_learning.py stats
                        python3 manage_learning.py patterns || echo "Patterns not yet tracked"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Pipeline completed"
                
                // Archive learning database
                sh '''
                    if [ -f "error_learning.json" ]; then
                        mkdir -p learning-reports
                        cp error_learning.json learning-reports/error_learning_${BUILD_NUMBER}.json
                    fi
                '''
            }
        }
        
        success {
            script {
                echo "‚úÖ Build successful!"
                
                // Check learning progress
                sh '''
                    python3 manage_learning.py promoted | head -20 || true
                '''
            }
        }
        
        failure {
            script {
                echo "‚ùå Build failed - learning database still tracks outcomes"
                
                sh '''
                    echo "Checking if any patterns are close to promotion..."
                    python3 manage_learning.py patterns | grep -i "learning" || true
                '''
            }
        }
    }
}

/*
  INTEGRATION WITH GITHUB WEBHOOKS
  ================================
  
  1. GitHub sends webhook event when PR is closed
  2. Jenkins receives at endpoint: /github-webhook/
  3. Webhook handler processes event:
     - Extracts error patterns from PR body
     - Records success (if merged) or failure (if closed)
     - Updates learning database
     - Checks for pattern promotion
  
  4. Next build uses updated confidence scores
  
  Example Webhook Event (PR Merged):
  {
    "action": "closed",
    "pull_request": {
      "number": 42,
      "title": "[Auto-Fix] 2 low-confidence issues need review",
      "merged": true,
      "body": "... error pattern details ..."
    }
  }
  
  Jenkins Handler Processing:
  - Receives webhook JSON
  - Calls: python3 github_webhook_handler.py
  - Outputs:
    ‚úÖ AUTO-FIX PR #42 MERGED - Recording as SUCCESS
    üìà PROMOTING: business_logic:NullPointerException
    Reason: Reached 5 consecutive successes
*/
